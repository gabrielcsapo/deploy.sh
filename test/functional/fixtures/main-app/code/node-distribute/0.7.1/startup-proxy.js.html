<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>startup-proxy.js - Documentation</title>

    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="https://code.ionicframework.com/ionicons/2.0.1/css/ionicons.min.css">
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="Config.html">Config</a><ul class='methods'><li data-type='method'><a href="Config.html#.generate">generate</a></li><li data-type='method'><a href="Config.html#.get">get</a></li><li data-type='method'><a href="Config.html#.update">update</a></li></ul></li><li><a href="Process.html">Process</a><ul class='methods'><li data-type='method'><a href="Process.html#.get">get</a></li></ul></li><li><a href="Repo.html">Repo</a><ul class='methods'><li data-type='method'><a href="Repo.html#.get">get</a></li><li data-type='method'><a href="Repo.html#.update">update</a></li></ul></li><li><a href="Server.html">Server</a><ul class='methods'><li data-type='method'><a href="Server.html#.defaults">defaults</a></li><li data-type='method'><a href="Server.html#.get">get</a></li></ul></li><li><a href="User.html">User</a><ul class='methods'><li data-type='method'><a href="User.html#.get">get</a></li></ul></li></ul><h3>Modules</h3><ul><li><a href="module-db.html">db</a></li><li><a href="module-git-deploy.html">git-deploy</a></li><li><a href="module-process-listen.html">process-listen</a></li><li><a href="module-process-uage.html">process-uage</a></li><li><a href="module-startup-admin.html">startup-admin</a></li><li><a href="module-startup-application.html">startup-application</a></li><li><a href="module-startup-application-static.html">startup-application-static</a></li><li><a href="module-startup-applications.html">startup-applications</a></li><li><a href="module-startup-gitserver.html">startup-gitserver</a></li><li><a href="module-startup-proxy.html">startup-proxy</a><ul class='methods'><li data-type='method'><a href="module-startup-proxy.html#~isAuthenticated">isAuthenticated</a></li></ul></li></ul>
</nav>

<div id="main">
    
    <h1 class="page-title">startup-proxy.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 * Starts the proxy server
 * @module startup-proxy
 */

var express = require('express');
var app = express();
var basicAuth = require('basic-auth-connect');
var path = require('path');
var request = require('request');
var responseTime = require('response-time');
var moment = require('moment');
var geoip = require('geoip-lite');
var child_process = require('child_process');
var bodyParser = require('body-parser');
var startApplication = require('./startup-application');
var uaParser = require('ua-parser-js');
var server = require('http').Server(app);
var io = require('socket.io')(server);

module.exports = function() {
    var User = require('./lib/user');
    var Repos = require('./lib/repos');
    var Log = require('./lib/log');
    var db = require('./lib/db');
    var Processes = require('./lib/processes');
    var Server = require('./lib/server');

    var getHostname = function(req) {
        var hostname = req.headers.host.split(':')[0] ? req.headers.host.split(':')[0].substring(0, req.headers.host.split(':')[0].indexOf('.')) : req.subdomains;
        // We are looking for the main app, which we use * to denote no hostname
        hostname = hostname == '' ? '*' : hostname;
        return hostname;
    };

    var logs = child_process.fork(`${__dirname}/process-listen.js`);
    logs.on('message', function(m) {
        var name = m.name;
        var type = m.type;
        var data = m.data;
        var formattedLog = Log.application(name, data, type);
        db(name, 'logs').push(formattedLog);
        io.sockets.emit(name + '-logs', formattedLog);
    });

    var usage = child_process.fork(`${__dirname}/process-usage.js`);
    usage.on('message', function(m) {
        if (m.monit) {
            var cpu = [moment().format('x'), m.monit.cpu];
            var memory = [moment().format('x'), m.monit.memory];

            io.sockets.emit(m.name + '-memory', {
                cpu: cpu,
                memory: memory
            });

            io.sockets.emit(m.name + '-uptime', {
                created_at: m.created_at,
                status: m.status,
                instances: m.instances
            });
        }
    });

    app.use(responseTime(function(req, res, time) {
        var ip = req.query.ip ||
            req.headers['x-forwarded-for'] ||
            req.headers['X-Forwarded-For'] ||
            req.connection.remoteAddress ||
            req.socket.remoteAddress ||
            req.connection.socket.remoteAddress;
        var geo = geoip.lookup(ip);
        var referrer = req.get('Referrer');
        var hostname = getHostname(req);
        Repos.get().forEach(function(repo) {
            if (repo.subdomain == hostname) {
                var trafficInstance = {
                  'date': moment().format('x'),
                  'time': time,
                  'geo': geo,
                  'referrer': referrer,
                  'ua': uaParser(req.headers['user-agent'])
                };
                if (db(repo.name, 'traffic').find({
                        url: req._parsedUrl.pathname
                    })) {
                    db(repo.name, 'traffic').find({
                        url: req._parsedUrl.pathname
                    }).traffic.push(trafficInstance);
                } else {
                    db(repo.name, 'traffic').push({
                        url: req._parsedUrl.pathname,
                        traffic: [trafficInstance]
                    });
                }
                io.sockets.emit(repo.name + '-traffic', {
                    url: req.originalUrl,
                    traffic: [trafficInstance]
                });
            }
        });
    }));

    /** this is going to be the API that can be served to the admin application */

    var isAuthenticated = function(req, res, next) {
        // Opens the door to having a server that is not authentication protected
        // This helps with local debugging
        if (User.get().username &amp;&amp; User.get().password) {
            return basicAuth(User.get().username, User.get().password)(req, res, next);
        } else {
            next();
        }
    };

    var isAdminHost = function(req, res, next) {
        var hostname = getHostname(req);
        if (hostname == 'admin') {
            next();
        } else {
            res.status(404);
            res.sendFile(path.resolve(__dirname, 'views/404/index.html'));
        }
    };

    app.post('/api/process/:name/settings', isAdminHost, isAuthenticated, bodyParser.json(), function(req, res) {
        var name = req.params.name;
        Repos.update(req.body, function(error) {
            if (error) {
                res.status(500);
                res.send({
                    'error': error
                });
            } else {
                delete GLOBAL.wildcards[name];
                startApplication(Repos.get(name), path.resolve(__dirname, '..', 'app', name), Repos.get(), function() {
                    Log.info('app:restarted:', name);
                    res.status(200);
                    res.send({
                        'success': 'app updated and restarted'
                    });
                });
            }
        }, name);
    });
    app.get('/api/process/:name/json', isAdminHost, isAuthenticated, function(req, res) {
        var name = req.params.name;
        var process = Processes.get(name);
        if (process.repo) {
            res.send(process);
        } else {
            res.status(500);
            res.send();
        }
    });
    app.get('/api/process/json', isAdminHost, isAuthenticated, function(req, res) {
        res.send(Processes.get());
    });
    app.use('/api/process/:name/redeploy', isAdminHost, isAuthenticated, function(req, res) {
        var name = req.params.name;
        startApplication(Repos.get(name), function() {
            Log.info('app:restarted:', name);
            res.status(200);
            res.send({
                success: 'true'
            });
        });
    });

    app.all('*', function(req, res, next) {
        var hostname = getHostname(req);
        var repo = Repos.getByHostname(hostname);
        var port = GLOBAL.wildcards[hostname];
        var originalUrl = req.originalUrl;
        var url = `http://localhost:${port}${originalUrl}`;

        if (port) {
            req.pipe(request(url)).pipe(res);
        } else {
            next();
        }
    });

    app.use(function(req, res) {
        res.status(404);
        res.sendFile(path.resolve(__dirname, 'views/404/index.html'));
    });

    server.listen(Server.get().proxy.port, function() {
        Log.info('proxy listening on http://localhost:' + Server.get().proxy.port);
    });
};
</code></pre>
        </article>
    </section>




</div>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.4.3</a> on Sat Dec 03 2016 20:56:16 GMT-0800 (PST) using the Minami theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/linenumber.js"></script>
</body>
</html>
